<?php

namespace App\Services\Covepa;

use Carbon\Carbon;
use App\Models\Order;

class Helpers {

    /**
     * Mapeo con el tipo de pago con Covepa
     * 10 - transferencia
     * 15 - tarjeta credito
     * 26 - tarjeta debito
     */
    const TYPE_PAYMENT_MAPPING = [
        'VD' => 26,
        'VN' => 15,
        'VC' => 15,
        'SI' => 15,
        'S2' => 15,
        'NC' => 15,
        'VP' => 15,
    ];

    /**
     * Mapeo entre el ID de las comunas en SimpleGestion y el ID en Covepa
     * 
     * id_comuna_simple => id_covepa
     */
    const COMMUNE_MAPPING = [
        1 => ['id_commune' => 9, 'id_city' => 110],
        2 => ['id_commune' => 53, 'id_city' => 402],
        3 => ['id_commune' => 8, 'id_city' => 115],
        4 => ['id_commune' => 6, 'id_city' => 75],
        5 => ['id_commune' => 11, 'id_city' => 94],
        6 => ['id_commune' => 7, 'id_city' => 150],
        7 => ['id_commune' => 10, 'id_city' => 325],
        8 => ['id_commune' => 19, 'id_city' => 65],
        9 => ['id_commune' => 18, 'id_city' => 132],
        10 => ['id_commune' => 17, 'id_city' => 379],
        11 => ['id_commune' => 20, 'id_city' => 189],
        12 => ['id_commune' => 15, 'id_city' => 70],
        13 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        14 => ['id_commune' => 16, 'id_city' => 179],
        15 => ['id_commune' => 12, 'id_city' => 191],
        16 => ['id_commune' => 13, 'id_city' => 130],
        17 => ['id_commune' => 24, 'id_city' => 13],
        18 => ['id_commune' => 23, 'id_city' => 71],
        19 => ['id_commune' => 25, 'id_city' => 382],
        20 => ['id_commune' => 22, 'id_city' => 80],
        21 => ['id_commune' => 21, 'id_city' => 103],
        22 => ['id_commune' => 28, 'id_city' => 196],
        23 => ['id_commune' => 29, 'id_city' => 403],
        24 => ['id_commune' => 27, 'id_city' => 104],
        25 => ['id_commune' => 26, 'id_city' => 109],
        26 => ['id_commune' => 31, 'id_city' => 49],
        27 => ['id_commune' => 34, 'id_city' => 14],
        28 => ['id_commune' => 35, 'id_city' => 63],
        29 => ['id_commune' => 30, 'id_city' => 252],
        30 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        31 => ['id_commune' => 32, 'id_city' => 199],
        32 => ['id_commune' => 42, 'id_city' => 58],
        33 => ['id_commune' => 344, 'id_city' => 214],
        34 => ['id_commune' => 44, 'id_city' => 128],
        35 => ['id_commune' => 43, 'id_city' => 365],
        36 => ['id_commune' => 37, 'id_city' => 138],
        37 => ['id_commune' => 40, 'id_city' => 87],
        38 => ['id_commune' => 38, 'id_city' => 295],
        39 => ['id_commune' => 39, 'id_city' => 336],
        40 => ['id_commune' => 36, 'id_city' => 360],
        41 => ['id_commune' => 72, 'id_city' => 55],
        42 => ['id_commune' => 74, 'id_city' => 219],
        43 => ['id_commune' => 75, 'id_city' => 89],
        44 => ['id_commune' => 73, 'id_city' => 176],
        45 => ['id_commune' => 67, 'id_city' => 330],
        46 => ['id_commune' => 68, 'id_city' => 167],
        47 => ['id_commune' => 69, 'id_city' => 56],
        48 => ['id_commune' => 76, 'id_city' => 111],
        49 => ['id_commune' => 63, 'id_city' => 126],
        50 => ['id_commune' => 65, 'id_city' => 210],
        51 => ['id_commune' => 64, 'id_city' => 358],
        52 => ['id_commune' => 66, 'id_city' => 368],
        53 => ['id_commune' => 48, 'id_city' => 114],
        54 => ['id_commune' => 46, 'id_city' => 481],
        55 => ['id_commune' => 47, 'id_city' => 141],
        56 => ['id_commune' => 45, 'id_city' => 322],
        57 => ['id_commune' => 49, 'id_city' => 206],
        58 => ['id_commune' => 60, 'id_city' => 347],
        59 => ['id_commune' => 57, 'id_city' => 249],
        60 => ['id_commune' => 58, 'id_city' => 244],
        61 => ['id_commune' => 59, 'id_city' => 250],
        62 => ['id_commune' => 56, 'id_city' => 302],
        63 => ['id_commune' => 81, 'id_city' => 173],
        64 => ['id_commune' => 77, 'id_city' => 61],
        65 => ['id_commune' => 80, 'id_city' => 77],
        66 => ['id_commune' => 78, 'id_city' => 234],
        67 => ['id_commune' => 79, 'id_city' => 116],
        68 => ['id_commune' => 82, 'id_city' => 171],
        69 => ['id_commune' => 52, 'id_city' => 174],
        70 => ['id_commune' => 54, 'id_city' => 220],
        71 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        72 => ['id_commune' => 217, 'id_city' => 314],
        73 => ['id_commune' => 50, 'id_city' => 343],
        74 => ['id_commune' => 51, 'id_city' => 378],
        75 => ['id_commune' => 71, 'id_city' => 41],
        76 => ['id_commune' => 62, 'id_city' => 488],
        77 => ['id_commune' => 61, 'id_city' => 308],
        78 => ['id_commune' => 70, 'id_city' => 396],
        79 => ['id_commune' => 87, 'id_city' => 46],
        80 => ['id_commune' => 84, 'id_city' => 88],
        81 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        82 => ['id_commune' => 92, 'id_city' => 158],
        83 => ['id_commune' => 89, 'id_city' => 100],
        84 => ['id_commune' => 85, 'id_city' => 242],
        85 => ['id_commune' => 94, 'id_city' => 101],
        86 => ['id_commune' => 86, 'id_city' => 95],
        87 => ['id_commune' => 98, 'id_city' => 142],
        88 => ['id_commune' => 83, 'id_city' => 298],
        89 => ['id_commune' => 88, 'id_city' => 306],
        90 => ['id_commune' => 96, 'id_city' => 323],
        91 => ['id_commune' => 97, 'id_city' => 326],
        92 => ['id_commune' => 93, 'id_city' => 348],
        93 => ['id_commune' => 95, 'id_city' => 352],
        94 => ['id_commune' => 90, 'id_city' => 353],
        95 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        96 => ['id_commune' => 103, 'id_city' => 146],
        97 => ['id_commune' => 101, 'id_city' => 251],
        98 => ['id_commune' => 104, 'id_city' => 259],
        99 => ['id_commune' => 353, 'id_city' => 484],
        100 => ['id_commune' => 100, 'id_city' => 156],
        101 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        102 => ['id_commune' => 106, 'id_city' => 175],
        103 => ['id_commune' => 114, 'id_city' => 81],
        104 => ['id_commune' => 109, 'id_city' => 83],
        105 => ['id_commune' => 115, 'id_city' => 261],
        106 => ['id_commune' => 111, 'id_city' => 300],
        107 => ['id_commune' => 110, 'id_city' => 312],
        108 => ['id_commune' => 107, 'id_city' => 320],
        109 => ['id_commune' => 108, 'id_city' => 328],
        110 => ['id_commune' => 113, 'id_city' => 335],
        111 => ['id_commune' => 112, 'id_city' => 182],
        112 => ['id_commune' => 128, 'id_city' => 52],
        113 => ['id_commune' => 131, 'id_city' => 90],
        114 => ['id_commune' => 126, 'id_city' => 231],
        115 => ['id_commune' => 133, 'id_city' => 238],
        116 => ['id_commune' => 132, 'id_city' => 29],
        117 => ['id_commune' => 127, 'id_city' => 317],
        118 => ['id_commune' => 129, 'id_city' => 319],
        119 => ['id_commune' => 125, 'id_city' => 359],
        120 => ['id_commune' => 130, 'id_city' => 367],
        121 => ['id_commune' => 134, 'id_city' => 376],
        122 => ['id_commune' => 145, 'id_city' => 485],
        123 => ['id_commune' => 143, 'id_city' => 221],
        124 => ['id_commune' => 144, 'id_city' => 84],
        125 => ['id_commune' => 119, 'id_city' => 98],
        126 => ['id_commune' => 121, 'id_city' => 245],
        127 => ['id_commune' => 124, 'id_city' => 258],
        128 => ['id_commune' => 123, 'id_city' => 294],
        129 => ['id_commune' => 118, 'id_city' => 350],
        130 => ['id_commune' => 117, 'id_city' => 363],
        131 => ['id_commune' => 120, 'id_city' => 364],
        132 => ['id_commune' => 116, 'id_city' => 380],
        133 => ['id_commune' => 122, 'id_city' => 197],
        134 => ['id_commune' => 139, 'id_city' => 121],
        135 => ['id_commune' => 136, 'id_city' => 79],
        136 => ['id_commune' => 140, 'id_city' => 263],
        137 => ['id_commune' => 142, 'id_city' => 316],
        138 => ['id_commune' => 141, 'id_city' => 354],
        139 => ['id_commune' => 135, 'id_city' => 372],
        140 => ['id_commune' => 137, 'id_city' => 200],
        141 => ['id_commune' => 138, 'id_city' => 205],
        142 => ['id_commune' => 171, 'id_city' => 12],
        143 => ['id_commune' => 173, 'id_city' => 159],
        144 => ['id_commune' => 176, 'id_city' => 222],
        145 => ['id_commune' => 168, 'id_city' => 239],
        146 => ['id_commune' => 172, 'id_city' => 246],
        147 => ['id_commune' => 174, 'id_city' => 267],
        148 => ['id_commune' => 169, 'id_city' => 144],
        149 => ['id_commune' => 177, 'id_city' => 375],
        150 => ['id_commune' => 175, 'id_city' => 183],
        151 => ['id_commune' => 170, 'id_city' => 51],
        152 => ['id_commune' => 167, 'id_city' => 192],
        153 => ['id_commune' => 346, 'id_city' => 73],
        154 => ['id_commune' => 194, 'id_city' => 118],
        155 => ['id_commune' => 191, 'id_city' => 66],
        156 => ['id_commune' => 195, 'id_city' => 76],
        157 => ['id_commune' => 196, 'id_city' => 91],
        158 => ['id_commune' => 192, 'id_city' => 229],
        159 => ['id_commune' => 193, 'id_city' => 265],
        160 => ['id_commune' => 197, 'id_city' => 166],
        161 => ['id_commune' => 185, 'id_city' => 59],
        162 => ['id_commune' => 181, 'id_city' => 404],
        163 => ['id_commune' => 178, 'id_city' => 405],
        164 => ['id_commune' => 183, 'id_city' => 113],
        165 => ['id_commune' => 190, 'id_city' => 299],
        166 => ['id_commune' => 186, 'id_city' => 135],
        167 => ['id_commune' => 187, 'id_city' => 86],
        168 => ['id_commune' => 189, 'id_city' => 344],
        169 => ['id_commune' => 184, 'id_city' => 345],
        170 => ['id_commune' => 182, 'id_city' => 180],
        171 => ['id_commune' => 188, 'id_city' => 377],
        172 => ['id_commune' => 180, 'id_city' => 393],
        173 => ['id_commune' => 179, 'id_city' => 397],
        174 => ['id_commune' => 315, 'id_city' => 401],
        175 => ['id_commune' => 155, 'id_city' => 10],
        176 => ['id_commune' => 159, 'id_city' => 207],
        177 => ['id_commune' => 146, 'id_city' => 225],
        178 => ['id_commune' => 158, 'id_city' => 226],
        179 => ['id_commune' => 154, 'id_city' => 227],
        180 => ['id_commune' => 166, 'id_city' => 223],
        181 => ['id_commune' => 163, 'id_city' => 232],
        182 => ['id_commune' => 151, 'id_city' => 301],
        183 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        184 => ['id_commune' => 164, 'id_city' => 318],
        185 => ['id_commune' => 157, 'id_city' => 149],
        186 => ['id_commune' => 156, 'id_city' => 329],
        187 => ['id_commune' => 162, 'id_city' => 346],
        188 => ['id_commune' => 150, 'id_city' => 349],
        189 => ['id_commune' => 161, 'id_city' => 137],
        190 => ['id_commune' => 149, 'id_city' => 366],
        191 => ['id_commune' => 148, 'id_city' => 369],
        192 => ['id_commune' => 160, 'id_city' => 371],
        193 => ['id_commune' => 153, 'id_city' => 374],
        194 => ['id_commune' => 152, 'id_city' => 400],
        195 => ['id_commune' => 165, 'id_city' => 398],
        196 => ['id_commune' => 213, 'id_city' => 53],
        197 => ['id_commune' => 214, 'id_city' => 215],
        198 => ['id_commune' => 218, 'id_city' => 162],
        199 => ['id_commune' => 226, 'id_city' => 230],
        200 => ['id_commune' => 219, 'id_city' => 483],
        201 => ['id_commune' => 210, 'id_city' => 240],
        202 => ['id_commune' => 222, 'id_city' => 241],
        203 => ['id_commune' => 211, 'id_city' => 24],
        204 => ['id_commune' => 227, 'id_city' => 262],
        205 => ['id_commune' => 215, 'id_city' => 293],
        206 => ['id_commune' => 216, 'id_city' => 304],
        207 => ['id_commune' => 228, 'id_city' => 53],
        208 => ['id_commune' => 209, 'id_city' => 321],
        209 => ['id_commune' => 220, 'id_city' => 475],
        210 => ['id_commune' => 223, 'id_city' => 155],
        211 => ['id_commune' => 102, 'id_city' => 334],
        212 => ['id_commune' => 221, 'id_city' => 381],
        213 => ['id_commune' => 225, 'id_city' => 389],
        214 => ['id_commune' => 212, 'id_city' => 395],
        215 => ['id_commune' => 224, 'id_city' => 203],
        216 => ['id_commune' => 345, 'id_city' => 224],
        217 => ['id_commune' => 199, 'id_city' => 64],
        218 => ['id_commune' => 200, 'id_city' => 482],
        219 => ['id_commune' => 207, 'id_city' => 168],
        220 => ['id_commune' => 203, 'id_city' => 139],
        221 => ['id_commune' => 208, 'id_city' => 264],
        222 => ['id_commune' => 201, 'id_city' => 266],
        223 => ['id_commune' => 204, 'id_city' => 268],
        224 => ['id_commune' => 202, 'id_city' => 342],
        225 => ['id_commune' => 198, 'id_city' => 351],
        226 => ['id_commune' => 206, 'id_city' => 392],
        227 => ['id_commune' => 205, 'id_city' => 198],
        228 => ['id_commune' => 1, 'id_city' => 1],
        229 => ['id_commune' => 253, 'id_city' => 6],
        230 => ['id_commune' => 254, 'id_city' => 419],
        231 => ['id_commune' => 248, 'id_city' => 20],
        232 => ['id_commune' => 247, 'id_city' => 21],
        233 => ['id_commune' => 251, 'id_city' => 30],
        234 => ['id_commune' => 249, 'id_city' => 26],
        235 => ['id_commune' => 252, 'id_city' => 28],
        236 => ['id_commune' => 250, 'id_city' => 39],
        237 => ['id_commune' => 259, 'id_city' => 7],
        238 => ['id_commune' => 255, 'id_city' => 3],
        239 => ['id_commune' => 260, 'id_city' => 11],
        240 => ['id_commune' => 258, 'id_city' => 17],
        241 => ['id_commune' => 257, 'id_city' => 18],
        242 => ['id_commune' => 264, 'id_city' => 341],
        243 => ['id_commune' => 261, 'id_city' => 44],
        244 => ['id_commune' => 262, 'id_city' => 40],
        245 => ['id_commune' => 256, 'id_city' => 42],
        246 => ['id_commune' => 263, 'id_city' => 2],
        247 => ['id_commune' => 243, 'id_city' => 32],
        248 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        249 => ['id_commune' => 245, 'id_city' => 38],
        250 => ['id_commune' => 341, 'id_city' => 478],
        251 => ['id_commune' => 244, 'id_city' => 466],
        252 => ['id_commune' => 350, 'id_city' => 479],
        253 => ['id_commune' => 241, 'id_city' => 468],
        254 => ['id_commune' => 265, 'id_city' => 9],
        255 => ['id_commune' => 266, 'id_city' => 105],
        256 => ['id_commune' => 268, 'id_city' => 427],
        257 => ['id_commune' => 267, 'id_city' => 60],
        258 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        259 => ['id_commune' => 273, 'id_city' => 253],
        260 => ['id_commune' => '#N/A', 'id_city' => '#N/A'],
        261 => ['id_commune' => 270, 'id_city' => 160],
        262 => ['id_commune' => 269, 'id_city' => 487],
        263 => ['id_commune' => 276, 'id_city' => 85],
        264 => ['id_commune' => 278, 'id_city' => 305],
        265 => ['id_commune' => 277, 'id_city' => 391],
        266 => ['id_commune' => 275, 'id_city' => 82],
        267 => ['id_commune' => 274, 'id_city' => 361],
        268 => ['id_commune' => 284, 'id_city' => 37],
        269 => ['id_commune' => 281, 'id_city' => 255],
        270 => ['id_commune' => 283, 'id_city' => 362],
        271 => ['id_commune' => 282, 'id_city' => 370],
        272 => ['id_commune' => 343, 'id_city' => 163],
        273 => ['id_commune' => 288, 'id_city' => 202],
        274 => ['id_commune' => 285, 'id_city' => 153],
        275 => ['id_commune' => 286, 'id_city' => 476],
        276 => ['id_commune' => 287, 'id_city' => 387],
        277 => ['id_commune' => 280, 'id_city' => 34],
        278 => ['id_commune' => 279, 'id_city' => 390],
        279 => ['id_commune' => 299, 'id_city' => 50],
        280 => ['id_commune' => 321, 'id_city' => 8],
        281 => ['id_commune' => 323, 'id_city' => 50],
        282 => ['id_commune' => 292, 'id_city' => 50],
        283 => ['id_commune' => 317, 'id_city' => 50],
        284 => ['id_commune' => 320, 'id_city' => 50],
        285 => ['id_commune' => 308, 'id_city' => 50],
        286 => ['id_commune' => 307, 'id_city' => 50],
        287 => ['id_commune' => 304, 'id_city' => 50],
        288 => ['id_commune' => 305, 'id_city' => 50],
        289 => ['id_commune' => 306, 'id_city' => 50],
        290 => ['id_commune' => 342, 'id_city' => 50],
        291 => ['id_commune' => 300, 'id_city' => 50],
        292 => ['id_commune' => 295, 'id_city' => 25],
        293 => ['id_commune' => 311, 'id_city' => 50],
        294 => ['id_commune' => 319, 'id_city' => 50],
        295 => ['id_commune' => 322, 'id_city' => 50],
        296 => ['id_commune' => 312, 'id_city' => 50],
        297 => ['id_commune' => 303, 'id_city' => 50],
        298 => ['id_commune' => 301, 'id_city' => 50],
        299 => ['id_commune' => 318, 'id_city' => 50],
        300 => ['id_commune' => 313, 'id_city' => 50],
        301 => ['id_commune' => 298, 'id_city' => 50],
        302 => ['id_commune' => 296, 'id_city' => 50],
        303 => ['id_commune' => 293, 'id_city' => 50],
        304 => ['id_commune' => 297, 'id_city' => 45],
        305 => ['id_commune' => 309, 'id_city' => 50],
        306 => ['id_commune' => 294, 'id_city' => 50],
        307 => ['id_commune' => 314, 'id_city' => 50],
        308 => ['id_commune' => 302, 'id_city' => 50],
        309 => ['id_commune' => 316, 'id_city' => 50],
        310 => ['id_commune' => 310, 'id_city' => 50],
        311 => ['id_commune' => 325, 'id_city' => 50],
        312 => ['id_commune' => 326, 'id_city' => 327],
        313 => ['id_commune' => 324, 'id_city' => 373],
        314 => ['id_commune' => 290, 'id_city' => 50],
        315 => ['id_commune' => 291, 'id_city' => 257],
        316 => ['id_commune' => 289, 'id_city' => 383],
        317 => ['id_commune' => 327, 'id_city' => 48],
        318 => ['id_commune' => 329, 'id_city' => 5],
        319 => ['id_commune' => 328, 'id_city' => 50],
        320 => ['id_commune' => 330, 'id_city' => 311],
        321 => ['id_commune' => 337, 'id_city' => 133],
        322 => ['id_commune' => 339, 'id_city' => 248],
        323 => ['id_commune' => 335, 'id_city' => 228],
        324 => ['id_commune' => 336, 'id_city' => 123],
        325 => ['id_commune' => 338, 'id_city' => 178],
        326 => ['id_commune' => 332, 'id_city' => 125],
        327 => ['id_commune' => 333, 'id_city' => 233],
        328 => ['id_commune' => 334, 'id_city' => 247],
        329 => ['id_commune' => 340, 'id_city' => 309],
        330 => ['id_commune' => 331, 'id_city' => 50],
        331 => ['id_commune' => 233, 'id_city' => 57],
        332 => ['id_commune' => 235, 'id_city' => 15],
        333 => ['id_commune' => 229, 'id_city' => 57],
        334 => ['id_commune' => 234, 'id_city' => 438],
        335 => ['id_commune' => 232, 'id_city' => 57],
        336 => ['id_commune' => 230, 'id_city' => 27],
        337 => ['id_commune' => 236, 'id_city' => 33],
        338 => ['id_commune' => 231, 'id_city' => 140],
        339 => ['id_commune' => 239, 'id_city' => 54],
        340 => ['id_commune' => 237, 'id_city' => 426],
        341 => ['id_commune' => 238, 'id_city' => 23],
        342 => ['id_commune' => 240, 'id_city' => 47],
        343 => ['id_commune' => 4, 'id_city' => 67],
        344 => ['id_commune' => 5, 'id_city' => 213],
        345 => ['id_commune' => 3, 'id_city' => 165],
        346 => ['id_commune' => 2, 'id_city' => 204],
    ];

    public static function getPaymentArray(Order $order) : array
    {
        $payment = $order->order_payments->first(); 
        $rut = str_replace('.', '', $order->uid);
        $rut = str_replace('-', '', $rut);

        if ($payment->method === 'tbkplus') {
            $details = json_decode($payment->json_in, true);
            $authCode = (int) $details['data']['detailOutput']['authorizationCode'];
            $quotes = $details['data']['detailOutput']['sharesNumber'] == 0 ? 1 : $details['data']['detailOutput']['sharesNumber'];
            $paymentType = self::TYPE_PAYMENT_MAPPING[$details['data']['detailOutput']['paymentTypeCode']];   
        }

        return [
            [ 
                "FORPGO_CODIGO" => $paymentType,
                "VTAPGO_CORREL" => 1,
                "VTAPGO_MONPGO" => (double) $order->total,
                "VTAPGO_NCUOTA" => $quotes, // numero de cuotas
                "VTAPGO_FECUOT" => Carbon::now()->format('d/m/Y'), // fecha primera cuota
                "VTAPGO_NRDCPG" => $authCode, // Confirmar si es autorizacion de transbank
                "SUJETO_RUTDUE" => $rut, // Rut cliente que paga @todo sanitizar
                "SUJETO_RUTSUJ" => $rut // Rut del documento de venta
            ]
        ];
    }
}